# ADR-12: Выгрузка операционных задач в API-шлюзы.

## Статус

Предложено

## Контекст

На данный момент мы извлекли 8 сервисов. Теперь встает вопрос - как обрабатывать аутентификацию и авторизацию? Как гарантировать, что фронтенды получают доступ только к разрешенным им сервисам? Что насчет журналирования? Следует ли реализовывать эти вещи в каждом сервисе и, таким образом, создавать дублирование кода? Или мы можем выгрузить доменные сервисы от этого операционного функционала?

## Решение

Здесь могут пригодиться API-шлюзы. Похоже, что имеет смысл иметь отдельные API-шлюзы для каждого доменного кванта по той же причине, которую мы объясняем в [ADR-1](ADR/ADR-1-service-based.md) - они могут требовать различные архитектурные особенности.

Какие шлюзы нам нужны? Первым кандидатом является биллинговый квант, поскольку это самый высокий уровень риска безопасности и его следует изолировать от остальной системы насколько это возможно. Мы не хотим, чтобы сотрудники администрации или клиенты получали доступ к данным чьей-либо кредитной карты.
Административный API работает с административными разрешениями, поэтому любое вторжение здесь будет иметь серьезные последствия для всего бизнеса.
API для клиентов и API для системных операторов требуют разных уровней доступности и масштабируемости, поэтому это еще один шлюз. А мобильное приложение может потребовать более эффективных ответов на данные, чем веб-приложения.

Важно отметить, что API-шлюзы не должны содержать доменной логики. Помните, мы не создаем ESB (Enterprise Service Bus) здесь. API-шлюзы должны заботиться исключительно о контроле доступа, проверках безопасности и простой маршрутизации сообщений на основе их типа. Мы оставляем запросы от шлюзов к соответствующим доменным сервисам синхронными, чтобы шлюзы были простыми прокси-интерфейсами. Ведь если клиент что-то изменит в своем профиле и обновит страницу, изменения должны мгновенно отображаться.

Еще одно важное замечание заключается в том, что сервисы в разных доменах должны общаться только через API-шлюзы, в то время как сервисы внутри одного кванта могут общаться напрямую. Это относится как к синхронному, так и к асинхронному обмену сообщениями через очередь сообщений (см. [ADR-2](ADR/ADR-2-event-driven-broker.md)). Например, обработчик заявок (Ticket Processor) в основном является деталью реализации API для заявок (Ticket API), поэтому они могут общаться напрямую. Если этот способ коммуникации изменится между этими двумя сервисами, API-шлюз для системных операторов (Sysops API Gateway) не будет заботиться об этом. С другой стороны, API для клиентов (Customer API) отправляет заявки на обработку только через API-шлюз для системных операторов. Таким образом, API-шлюз также выполняет роль _фасада_ для других квантов.

На рынке существует множество вариантов для реализации шлюзов - открытые исходные коды, проприетарные и облачные.

## Последствия

Снова возрастает сложность из-за увеличения числа сервисов. Необходимо тщательно следить за разработкой API-шлюзов, чтобы избежать узких мест в производительности и единой точки отказа, поэтому они должны быть правильно балансированы по нагрузке.
API-шлюзы также требуют дополнительных затрат на разработку и последующую поддержку.
